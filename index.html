<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 8px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        #peerId {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        input {
            padding: 8px;
            font-size: 14px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Webcam Live Stream</h1>

    <div class="controls">
        <button id="broadcasterBtn">Start Broadcasting</button>
        <button id="viewerBtn">View Stream</button>
    </div>

    <div id="broadcasterSection" style="display:none;">
        <div class="info">
            <h3>Broadcasting</h3>
            <p>Your Peer ID: <span id="peerId"></span></p>
            <p>Share this ID with viewers</p>
        </div>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div id="viewerSection" style="display:none;">
        <div class="info">
            <h3>View Stream</h3>
            <input type="text" id="peerIdInput" placeholder="Enter broadcaster's Peer ID">
            <button id="connectBtn">Connect</button>
        </div>
        <video id="remoteVideo" autoplay playsinline controls></video>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script>
        let peer;
        let localStream;

        document.getElementById('broadcasterBtn').addEventListener('click', startBroadcasting);
        document.getElementById('viewerBtn').addEventListener('click', showViewerSection);
        document.getElementById('connectBtn').addEventListener('click', connectToStream);

        async function startBroadcasting() {
            try {
                // Get webcam stream with specific constraints
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });

                console.log('Local stream tracks:', localStream.getTracks());
                console.log('Video tracks:', localStream.getVideoTracks());
                console.log('Audio tracks:', localStream.getAudioTracks());

                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;

                // Create peer with random ID and config for better video quality
                peer = new Peer({
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ],
                        sdpSemantics: 'unified-plan'
                    }
                });

                peer.on('open', (id) => {
                    document.getElementById('peerId').textContent = id;
                    document.getElementById('broadcasterSection').style.display = 'block';
                    document.getElementById('viewerSection').style.display = 'none';
                    console.log('My peer ID is: ' + id);
                    console.log('Broadcasting stream with tracks:', localStream.getTracks().length);
                });

                // Answer incoming calls
                peer.on('call', (call) => {
                    console.log('Incoming call, answering with stream');
                    console.log('Sending tracks:', localStream.getTracks());

                    // Ensure video track is enabled
                    localStream.getVideoTracks().forEach(track => {
                        track.enabled = true;
                        console.log('Video track enabled:', track.id, track.readyState);
                    });

                    call.answer(localStream);

                    // Monitor connection
                    call.on('stream', (stream) => {
                        console.log('Connection established, stream flowing');
                    });

                    call.on('close', () => {
                        console.log('Call closed');
                    });

                    call.on('error', (err) => {
                        console.error('Call error:', err);
                    });
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Error: ' + err.type);
                });

            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Could not access webcam: ' + err.message);
            }
        }

        function showViewerSection() {
            document.getElementById('viewerSection').style.display = 'block';
            document.getElementById('broadcasterSection').style.display = 'none';

            if (!peer) {
                peer = new Peer({
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ],
                        sdpSemantics: 'unified-plan'
                    }
                });
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Error: ' + err.type);
                });
            }
        }

        async function connectToStream() {
            const remotePeerId = document.getElementById('peerIdInput').value.trim();

            if (!remotePeerId) {
                alert('Please enter a Peer ID');
                return;
            }

            // Create dummy stream with both audio AND video
            // This ensures WebRTC negotiates for both tracks
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const dummyVideoStream = canvas.captureStream();

            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const dst = oscillator.connect(audioContext.createMediaStreamDestination());
            oscillator.start();
            const dummyAudioTrack = dst.stream.getAudioTracks()[0];

            // Combine audio and video tracks
            const dummyStream = new MediaStream([
                ...dummyVideoStream.getVideoTracks(),
                dummyAudioTrack
            ]);

            console.log('Calling peer:', remotePeerId);
            console.log('Dummy stream tracks:', dummyStream.getTracks());
            const call = peer.call(remotePeerId, dummyStream);

            call.on('stream', (remoteStream) => {
                console.log('Received stream');
                console.log('Stream tracks:', remoteStream.getTracks());
                console.log('Video tracks:', remoteStream.getVideoTracks());
                console.log('Audio tracks:', remoteStream.getAudioTracks());

                // Check if video tracks exist and are enabled
                const videoTracks = remoteStream.getVideoTracks();
                if (videoTracks.length === 0) {
                    console.error('NO VIDEO TRACKS RECEIVED!');
                    alert('Warning: No video track received, only audio');
                } else {
                    videoTracks.forEach(track => {
                        console.log('Video track details:', {
                            id: track.id,
                            enabled: track.enabled,
                            muted: track.muted,
                            readyState: track.readyState,
                            settings: track.getSettings()
                        });
                    });
                }

                const videoElement = document.getElementById('remoteVideo');
                videoElement.srcObject = remoteStream;

                // Wait for metadata to load, then play
                videoElement.onloadedmetadata = () => {
                    console.log('Metadata loaded, attempting to play...');
                    console.log('Video dimensions:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                    videoElement.play().then(() => {
                        console.log('Playing successfully!');
                    }).catch(err => {
                        console.log('Autoplay blocked:', err);
                        alert('Stream received! Click the play button to start.');
                    });
                };
            });

            call.on('error', (err) => {
                console.error('Call error:', err);
                alert('Could not connect: ' + err.message);
            });
        }
    </script>
</body>
</html>
