<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Stream</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 8px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .arduino-control {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        #arduinoBtn {
            background: #28a745;
            padding: 15px 30px;
            font-size: 18px;
        }
        #arduinoBtn:hover {
            background: #218838;
        }
        #arduinoBtn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status.connected {
            background: #28a745;
        }
        .status.disconnected {
            background: #dc3545;
        }
        #peerId {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
        input {
            padding: 8px;
            font-size: 14px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Webcam Live Stream</h1>

    <div class="controls">
        <button id="broadcasterBtn">Start Broadcasting</button>
        <button id="viewerBtn">View Stream</button>
    </div>

    <div class="arduino-control">
        <h3>Arduino LED Control (Optional)</h3>
        <p style="font-size: 14px; color: #666; margin: 10px 0;">
            Webcam streaming works without Arduino. Connect Arduino for LED control features.
        </p>

        <div style="margin: 15px 0; padding: 10px; background: #e9ecef; border-radius: 4px;">
            <label for="backendUrlInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Arduino Server URL:</label>
            <input type="text" id="backendUrlInput" placeholder="http://localhost:3000"
                   style="width: 70%; padding: 8px; margin-right: 5px;" value="http://localhost:3000">
            <button id="connectBackendBtn" style="padding: 8px 15px;">Connect</button>
            <p style="font-size: 12px; margin: 5px 0 0 0; color: #666;">
                Enter the Arduino server URL (e.g., http://192.168.1.100:3000 or ngrok URL)
            </p>
        </div>

        <p>
            <span class="status disconnected" id="connectionStatus"></span>
            <span id="statusText">Not Connected</span>
        </p>

        <div style="margin: 15px 0;">
            <h4 style="margin: 10px 0;">Red LED (Pin 13)</h4>
            <button id="redOnBtn" style="background: #dc3545;">Turn Red ON</button>
            <button id="redOffBtn" style="background: #6c757d;">Turn Red OFF</button>
        </div>

        <div style="margin: 15px 0;">
            <h4 style="margin: 10px 0;">Blue LED (Pin 12)</h4>
            <button id="blueOnBtn" style="background: #007bff;">Turn Blue ON</button>
            <button id="blueOffBtn" style="background: #6c757d;">Turn Blue OFF</button>
        </div>

        <div style="margin: 15px 0;">
            <h4 style="margin: 10px 0;">Both LEDs</h4>
            <button id="allOnBtn" style="background: #28a745;">Turn Both ON</button>
            <button id="allOffBtn" style="background: #6c757d;">Turn Both OFF</button>
        </div>

        <div style="margin: 15px 0;">
            <h4 style="margin: 10px 0;">Alternate Mode</h4>
            <button id="alternateStartBtn" style="background: #ffc107; color: #000;">Start Alternating</button>
            <button id="alternateStopBtn" style="background: #dc3545;">Stop Alternating</button>
        </div>

        <!-- Keep old toggle button for backward compatibility -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
            <button id="arduinoBtn">Toggle LED (Legacy)</button>
        </div>
    </div>

    <div id="broadcasterSection" style="display:none;">
        <div class="info">
            <h3>Broadcasting</h3>
            <p>Your Peer ID: <span id="peerId"></span></p>
            <p>Share this ID with viewers</p>
        </div>
        <video id="localVideo" autoplay muted playsinline></video>
    </div>

    <div id="viewerSection" style="display:none;">
        <div class="info">
            <h3>View Stream</h3>
            <input type="text" id="peerIdInput" placeholder="Enter broadcaster's Peer ID">
            <button id="connectBtn">Connect</button>
        </div>
        <video id="remoteVideo" autoplay playsinline controls></video>
    </div>

    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script>
        let peer;
        let localStream;

        // Arduino control variables
        let BACKEND_URL = localStorage.getItem('arduinoBackendUrl') || 'http://localhost:3000';
        let isArduinoConnected = false;
        let connectionCheckInterval;

        // Load saved URL into input field
        document.getElementById('backendUrlInput').value = BACKEND_URL;

        document.getElementById('broadcasterBtn').addEventListener('click', startBroadcasting);
        document.getElementById('viewerBtn').addEventListener('click', showViewerSection);
        document.getElementById('connectBtn').addEventListener('click', connectToStream);
        document.getElementById('arduinoBtn').addEventListener('click', toggleArduinoLED);

        // Backend URL configuration
        document.getElementById('connectBackendBtn').addEventListener('click', connectToBackend);

        // Dual LED control event listeners
        document.getElementById('redOnBtn').addEventListener('click', () => controlLED('red/on'));
        document.getElementById('redOffBtn').addEventListener('click', () => controlLED('red/off'));
        document.getElementById('blueOnBtn').addEventListener('click', () => controlLED('blue/on'));
        document.getElementById('blueOffBtn').addEventListener('click', () => controlLED('blue/off'));
        document.getElementById('allOnBtn').addEventListener('click', () => controlLED('all/on'));
        document.getElementById('allOffBtn').addEventListener('click', () => controlLED('all/off'));
        document.getElementById('alternateStartBtn').addEventListener('click', () => controlLED('alternate/start'));
        document.getElementById('alternateStopBtn').addEventListener('click', () => controlLED('alternate/stop'));

        // Function to connect to backend
        function connectToBackend() {
            const inputUrl = document.getElementById('backendUrlInput').value.trim();
            if (!inputUrl) {
                alert('Please enter a backend URL');
                return;
            }

            // Remove trailing slash if present
            BACKEND_URL = inputUrl.replace(/\/$/, '');

            // Save to localStorage
            localStorage.setItem('arduinoBackendUrl', BACKEND_URL);

            console.log('Connecting to backend:', BACKEND_URL);

            // Stop existing interval
            if (connectionCheckInterval) {
                clearInterval(connectionCheckInterval);
            }

            // Check connection immediately
            checkArduinoConnection();

            // Check status every 5 seconds
            connectionCheckInterval = setInterval(checkArduinoConnection, 5000);
        }

        // Check Arduino connection status on page load
        checkArduinoConnection();
        // Check status every 5 seconds
        connectionCheckInterval = setInterval(checkArduinoConnection, 5000);

        let consecutiveFailures = 0;
        const MAX_FAILURES_BEFORE_QUIET = 3;

        async function checkArduinoConnection() {
            try {
                const response = await fetch(`${BACKEND_URL}/arduino/status`);
                const data = await response.json();

                isArduinoConnected = data.connected;
                updateArduinoStatus(data.connected);
                consecutiveFailures = 0; // Reset on success
            } catch (error) {
                // Only log first 3 failures to avoid console spam
                if (consecutiveFailures < MAX_FAILURES_BEFORE_QUIET) {
                    console.log('Arduino server not available (this is OK - webcam still works)');
                    consecutiveFailures++;
                }
                isArduinoConnected = false;
                updateArduinoStatus(false);
            }
        }

        function updateArduinoStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');

            // Get all control buttons
            const buttons = [
                'arduinoBtn', 'redOnBtn', 'redOffBtn', 'blueOnBtn', 'blueOffBtn',
                'allOnBtn', 'allOffBtn', 'alternateStartBtn', 'alternateStopBtn'
            ];

            if (connected) {
                statusElement.className = 'status connected';
                statusText.textContent = 'Connected';
                buttons.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            } else {
                statusElement.className = 'status disconnected';
                statusText.textContent = 'Disconnected';
                buttons.forEach(id => {
                    document.getElementById(id).disabled = true;
                });
            }
        }

        // Generic function to control LEDs
        async function controlLED(endpoint) {
            if (!isArduinoConnected) {
                alert('Arduino is not connected!');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/arduino/${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log(`LED control success: ${endpoint}`);
                } else {
                    alert('Failed to control LED: ' + data.error);
                }
            } catch (error) {
                console.error('Error communicating with Arduino:', error);
                alert('Failed to communicate with Arduino server. Make sure the server is running!');
            }
        }

        async function toggleArduinoLED() {
            if (!isArduinoConnected) {
                alert('Arduino is not connected!');
                return;
            }

            try {
                const response = await fetch(`${BACKEND_URL}/arduino/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    console.log('LED toggled successfully');
                } else {
                    alert('Failed to toggle LED: ' + data.error);
                }
            } catch (error) {
                console.error('Error communicating with Arduino:', error);
                alert('Failed to communicate with Arduino server. Make sure the server is running!');
            }
        }

        async function startBroadcasting() {
            try {
                // Get webcam stream with specific constraints
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: true
                });

                console.log('Local stream tracks:', localStream.getTracks());
                console.log('Video tracks:', localStream.getVideoTracks());
                console.log('Audio tracks:', localStream.getAudioTracks());

                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;

                // Create peer with random ID and config for better video quality
                peer = new Peer({
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ],
                        sdpSemantics: 'unified-plan'
                    }
                });

                peer.on('open', (id) => {
                    document.getElementById('peerId').textContent = id;
                    document.getElementById('broadcasterSection').style.display = 'block';
                    document.getElementById('viewerSection').style.display = 'none';
                    console.log('My peer ID is: ' + id);
                    console.log('Broadcasting stream with tracks:', localStream.getTracks().length);
                });

                // Answer incoming calls
                peer.on('call', (call) => {
                    console.log('Incoming call, answering with stream');
                    console.log('Sending tracks:', localStream.getTracks());

                    // Ensure video track is enabled
                    localStream.getVideoTracks().forEach(track => {
                        track.enabled = true;
                        console.log('Video track enabled:', track.id, track.readyState);
                    });

                    call.answer(localStream);

                    // Monitor connection
                    call.on('stream', (stream) => {
                        console.log('Connection established, stream flowing');
                    });

                    call.on('close', () => {
                        console.log('Call closed');
                    });

                    call.on('error', (err) => {
                        console.error('Call error:', err);
                    });
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Error: ' + err.type);
                });

            } catch (err) {
                console.error('Error accessing webcam:', err);
                alert('Could not access webcam: ' + err.message);
            }
        }

        function showViewerSection() {
            document.getElementById('viewerSection').style.display = 'block';
            document.getElementById('broadcasterSection').style.display = 'none';

            if (!peer) {
                peer = new Peer({
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ],
                        sdpSemantics: 'unified-plan'
                    }
                });
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Error: ' + err.type);
                });
            }
        }

        async function connectToStream() {
            const remotePeerId = document.getElementById('peerIdInput').value.trim();

            if (!remotePeerId) {
                alert('Please enter a Peer ID');
                return;
            }

            // Create dummy stream with both audio AND video
            // This ensures WebRTC negotiates for both tracks
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const dummyVideoStream = canvas.captureStream();

            const audioContext = new AudioContext();
            const oscillator = audioContext.createOscillator();
            const dst = oscillator.connect(audioContext.createMediaStreamDestination());
            oscillator.start();
            const dummyAudioTrack = dst.stream.getAudioTracks()[0];

            // Combine audio and video tracks
            const dummyStream = new MediaStream([
                ...dummyVideoStream.getVideoTracks(),
                dummyAudioTrack
            ]);

            console.log('Calling peer:', remotePeerId);
            console.log('Dummy stream tracks:', dummyStream.getTracks());
            const call = peer.call(remotePeerId, dummyStream);

            call.on('stream', (remoteStream) => {
                console.log('Received stream');
                console.log('Stream tracks:', remoteStream.getTracks());
                console.log('Video tracks:', remoteStream.getVideoTracks());
                console.log('Audio tracks:', remoteStream.getAudioTracks());

                // Check if video tracks exist and are enabled
                const videoTracks = remoteStream.getVideoTracks();
                if (videoTracks.length === 0) {
                    console.error('NO VIDEO TRACKS RECEIVED!');
                    alert('Warning: No video track received, only audio');
                } else {
                    videoTracks.forEach(track => {
                        console.log('Video track details:', {
                            id: track.id,
                            enabled: track.enabled,
                            muted: track.muted,
                            readyState: track.readyState,
                            settings: track.getSettings()
                        });
                    });
                }

                const videoElement = document.getElementById('remoteVideo');
                videoElement.srcObject = remoteStream;

                // Wait for metadata to load, then play
                videoElement.onloadedmetadata = () => {
                    console.log('Metadata loaded, attempting to play...');
                    console.log('Video dimensions:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                    videoElement.play().then(() => {
                        console.log('Playing successfully!');
                    }).catch(err => {
                        console.log('Autoplay blocked:', err);
                        alert('Stream received! Click the play button to start.');
                    });
                };
            });

            call.on('error', (err) => {
                console.error('Call error:', err);
                alert('Could not connect: ' + err.message);
            });
        }
    </script>
</body>
</html>
